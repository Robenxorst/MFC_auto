# MFC_auto
Программа для автоматической загрузки файлов с номерами абонентов в сервис обзвона

## Описание программы mfc_auto

Алгоритм работы программы:
1. Скрипт подключается к почте через `imap` и притягивает файл Excel с номерами абонентов из `последнего` письма. Письма приходят на данную почту в `9:00` и `14:00` по Мосвке. `Важно`: по праздникам приходит пустой Excel-файл, на что сделана доп обработка.
2. Парсер `parser_mfc` находит в полученном файле записи ВКС и создает загрузочный файл нужно формата (проект МФЦ Напоминания под номером 1).
3. Загрузочный файл отправляется на ендпоинт сервиса обзвона /addfile .
4. Переменные для работы скрипта притягиваются из Variabels `CI/CD`.
5. Скрипт запускается с помощью `Ofelia` (менеджер Cron для работы с Docker контейнерами) в `10:00` и `14:30` по будням, `11:00` и `15:00` по выходным.
6. Для поддержания контейнера со скриптом используется процесс в фоновом режиме `tail -f /dev/null`.
7. Команда для запуска скрипта внутри контейнера
```
python3 ./mfc_auto/mfc_auto.py
```
8. Для контроля работы скрипта используется мониторинг Телеграм.

## Скрипт для автоматической загрузки CSI МФЦ

Алгоритм работы скрипта:
1. Из ендпоинта сервиса `/export_xlsx_deleted/` притягивается файл Excel с прозвоненными номерами за вчерашний и позавчерашний день(скрипт отталкивается от текущей даты).
2. Парсер `parcer_mfc_csi` находит в столбце 'Дата Записи' заявки на вчерашний день и удалет из полученных записей не подтвержденных абонентов('Не подтвержден', 'Запись перенесена или отменена', 'Не звонить', 'Не записывался' в столбце 'Статус звонка'). Далее формируется загрузочный файл в формате проекта МФЦ CSI (номер 2).
3. Полученный файл загружается на ендпоинт `/addfile` (тот же сервис).
4. Переменные `URL`, `TOKEN`, `ENDPOINT` притягиваются из Variabels `CI/CD`.
5. Скрипт запускается с помощью `Ofelia` (менеджер Cron для работы с Docker контейнерами) каждый день в `11:00`.
6. Для поддержания контейнера со скриптом используется процесс в фоновом режиме `tail -f /dev/null`.
7. Команда для запуска скрипта внутри контейнера
```
python3 ./mfc_csi_auto/mfc_csi_auto.py
```
8. Для контроля работы скрипта используется мониторинг Телеграм.
